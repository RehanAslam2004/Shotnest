<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard | Shotnest</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap');
        
        :root {
            --bg-color: #09090b; --text-color: #e4e4e7;
            --sidebar-bg: #0c0c0e; --border-color: rgba(255,255,255,0.08);
            --card-bg: #18181b; --card-hover: #27272a;
            --active-bg: rgba(59, 130, 246, 0.1); --text-muted: #a1a1aa;
            --modal-bg: #18181b;
        }

        .light-mode {
            --bg-color: #f8fafc; --text-color: #1e293b;
            --sidebar-bg: #ffffff; --border-color: #e2e8f0;
            --card-bg: #ffffff; --card-hover: #f1f5f9;
            --active-bg: rgba(37, 99, 235, 0.1); --text-muted: #64748b;
            --modal-bg: #ffffff;
        }
        
        body { font-family: 'Outfit', sans-serif; background: var(--bg-color); color: var(--text-color); transition: background 0.3s ease, color 0.3s ease; margin: 0; padding: 0; overflow-x: hidden; }
        
        /* SIDEBAR (Desktop) */
        .sidebar { 
            background: var(--sidebar-bg); border-right: 1px solid var(--border-color); 
            position: fixed; top: 0; left: 0; bottom: 0; width: 260px; 
            display: flex; flex-direction: column; padding: 24px; z-index: 50; 
            transition: all 0.3s ease;
        }

        .nav-group { flex: 1; display: flex; flex-direction: column; gap: 6px; }
        
        .nav-item { 
            display: flex; align-items: center; gap: 12px; padding: 12px 16px; 
            border-radius: 12px; color: var(--text-muted); font-weight: 500; 
            font-size: 14px; transition: 0.2s; cursor: pointer; border: 1px solid transparent;
        }
        .nav-item:hover { background: var(--card-bg); color: var(--text-color); border-color: var(--border-color); }
        .nav-item.active { background: var(--active-bg); color: #3b82f6; font-weight: 600; border-color: rgba(59, 130, 246, 0.2); }
        
        /* MAIN CONTENT */
        .main-content { margin-left: 260px; padding: 40px 60px; width: auto; max-width: 1600px; min-height: 100vh; }

        /* GRID & CARDS */
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 40px; }
        
        .stat-card { background: var(--card-bg); border: 1px solid var(--border-color); padding: 20px; border-radius: 16px; display: flex; align-items: center; gap: 16px; transition: 0.2s; }
        .stat-card:hover { transform: translateY(-2px); border-color: rgba(255,255,255,0.1); }
        
        .project-card { 
            background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 20px; 
            padding: 0; transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); position: relative; 
            display: flex; flex-direction: column; overflow: hidden; height: 240px;
            cursor: pointer;
        }
        .project-card:hover { 
            transform: translateY(-4px) scale(1.01); 
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.3);
            border-color: rgba(59, 130, 246, 0.3);
        }
        
        .card-cover { height: 120px; width: 100%; position: relative; overflow: hidden; }
        .card-gradient { width: 100%; height: 100%; transition: 0.5s; opacity: 0.8; }
        .project-card:hover .card-gradient { transform: scale(1.1); opacity: 1; }
        
        .card-body { padding: 16px 20px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; background: var(--card-bg); z-index: 10; }
        
        .create-card { 
            border: 1px dashed var(--border-color); background: transparent; align-items: center; justify-content: center; 
            gap: 12px; height: 240px;
        }
        .create-card:hover { border-color: #3b82f6; background: rgba(59, 130, 246, 0.05); }

        .card-actions { position: absolute; top: 12px; right: 12px; display: flex; gap: 6px; z-index: 20; }
        .action-btn { 
            width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; 
            background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); color: white; border: 1px solid rgba(255,255,255,0.1); 
            transition: 0.2s; opacity: 0; transform: translateY(-5px);
        }
        .project-card:hover .action-btn { opacity: 1; transform: translateY(0); }
        .action-btn:hover { background: white; color: black; }
        .action-btn.favorite.active { color: #fbbf24; background: rgba(251, 191, 36, 0.1); border-color: #fbbf24; }
        .action-btn.favorite.active:hover { background: #fbbf24; color: black; }

        /* TAGS */
        .tag { font-size: 10px; font-weight: 700; padding: 4px 8px; border-radius: 6px; text-transform: uppercase; letter-spacing: 0.05em; }
        .tag-script { background: rgba(59, 130, 246, 0.15); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.2); }
        
        /* HEADER - FIXED CSS ERRORS */
        .welcome-header h1 { 
            font-size: 32px; font-weight: 700; letter-spacing: -0.02em; margin-bottom: 6px; 
            background: linear-gradient(to right, #fff, #9ca3af); 
            -webkit-background-clip: text; background-clip: text; 
            -webkit-text-fill-color: transparent; color: transparent;
        }
        .light-mode .welcome-header h1 { 
            background: linear-gradient(to right, #1e293b, #64748b); 
            -webkit-background-clip: text; background-clip: text;
        }

        /* --- MODAL STYLES --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
            z-index: 100; display: none; align-items: center; justify-content: center; padding: 20px;
        }
        .modal-panel {
            background: var(--modal-bg); border: 1px solid var(--border-color);
            width: 100%; max-width: 900px; border-radius: 24px; padding: 40px;
            box-shadow: 0 50px 100px -20px rgba(0,0,0,0.5); position: relative;
            transform: scale(0.95); opacity: 0; transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .modal-active .modal-panel { transform: scale(1); opacity: 1; }
        
        .selection-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 30px; }
        @media(max-width: 768px) { .selection-grid { grid-template-columns: 1fr; } }

        .select-card {
            background: rgba(255,255,255,0.03); border: 1px solid var(--border-color);
            border-radius: 20px; padding: 30px 20px; cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; align-items: center; text-align: center; gap: 15px;
            position: relative; overflow: hidden;
        }
        .select-card:hover {
            background: rgba(255,255,255,0.05); border-color: rgba(59, 130, 246, 0.4);
            transform: translateY(-5px);
        }
        .select-icon {
            width: 60px; height: 60px; border-radius: 16px; 
            display: flex; align-items: center; justify-content: center; font-size: 24px;
            margin-bottom: 5px;
        }
        .mode-badge {
            position: absolute; top: 12px; right: 12px; font-size: 9px; 
            font-weight: bold; text-transform: uppercase; padding: 4px 8px; 
            border-radius: 6px; opacity: 0.5; border: 1px solid currentColor;
        }

        /* --- MOBILE RESPONSIVENESS --- */
        @media(max-width: 768px) {
            .sidebar { 
                width: 100%; height: 70px; bottom: 0; top: auto; left: 0; 
                border-right: none; border-top: 1px solid var(--border-color); 
                flex-direction: row; padding: 0 16px; 
                justify-content: space-between; align-items: center; 
                background: var(--sidebar-bg); box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
            }
            .sidebar-logo, .sidebar-footer, .desktop-only { display: none !important; }
            .nav-group { flex-direction: row; width: 100%; justify-content: space-between; align-items: center; gap: 0; margin: 0; }
            .nav-item { flex-direction: column; gap: 4px; padding: 8px 0; font-size: 10px; border-radius: 8px; flex: 1; justify-content: center; height: 100%; margin: 0 2px; border: none; background: transparent !important; }
            .nav-item i { font-size: 18px; margin-bottom: 2px; }
            .nav-item.active { color: #3b82f6; }
            .nav-group .h-\[1px\] { display: none; }
            #mobileThemeBtn { display: flex !important; }
            .main-content { margin-left: 0; padding: 20px; padding-bottom: 120px; }
            .stats-grid { grid-template-columns: 1fr; gap: 10px; margin-bottom: 30px; }
            #projectGrid { grid-template-columns: 1fr; } 
            .action-btn { opacity: 1; transform: translateY(0); background: rgba(0,0,0,0.6); }
            .welcome-header h1 { font-size: 24px; }
            .modal-panel { padding: 20px; max-height: 85vh; overflow-y: auto; }
        }
    </style>
</head>
<body>
    
    <div class="sidebar">
        <div class="sidebar-logo flex items-center gap-3 mb-10 px-2">
            <div class="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center text-white shadow-lg shadow-blue-500/30"><i class="fa-solid fa-layer-group text-sm"></i></div>
            <span class="font-bold text-xl tracking-tight">Shotnest</span>
        </div>
        <div class="nav-group">
            <div id="filterAll" class="nav-item active" onclick="setFilter('all')"><i class="fa-solid fa-border-all w-5 text-center"></i> <span class="nav-text">Overview</span></div>
            <div id="filterFav" class="nav-item" onclick="setFilter('fav')"><i class="fa-regular fa-star w-5 text-center"></i> <span class="nav-text">Favorites</span></div>
            <div id="filterArc" class="nav-item desktop-only" onclick="setFilter('arc')"><i class="fa-solid fa-box-archive w-5 text-center"></i> <span class="nav-text">Archive</span></div>
            <div class="w-full h-[1px] bg-[var(--border-color)] my-4 opacity-50"></div>
            <div id="filterProd" class="nav-item" onclick="setFilter('prod')"><i class="fa-solid fa-briefcase w-5 text-center"></i> <span class="nav-text">Production</span></div>
            <div id="filterCal" class="nav-item" onclick="setFilter('cal')"><i class="fa-solid fa-calendar-days w-5 text-center"></i> <span class="nav-text">Calendar</span></div>
            <button id="mobileThemeBtn" class="nav-item md:hidden" style="display:none;" onclick="toggleTheme()"><i class="fa-solid fa-moon w-5 text-center"></i> <span class="nav-text">Theme</span></button>
        </div>
        <div class="sidebar-footer mt-auto border-t border-[var(--border-color)] pt-6 space-y-2">
            <button id="desktopThemeBtn" class="nav-item w-full" onclick="toggleTheme()"><i class="fa-solid fa-moon w-5"></i> Theme</button>
            <a href="/" class="nav-item"><i class="fa-solid fa-arrow-right-from-bracket w-5"></i> Log Out</a>
        </div>
    </div>

    <div class="main-content">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-10 gap-6">
            <div class="welcome-header">
                <h1 id="greeting">Good Afternoon, Creator</h1>
                <p class="text-sm opacity-60 font-medium" id="dateDisplay">Monday, Jan 01 • Time to create.</p>
            </div>
            <button onclick="openCreateModal()" class="w-full md:w-auto bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded-xl font-bold text-sm transition shadow-lg shadow-blue-600/20 flex items-center justify-center gap-2 transform hover:scale-105 active:scale-95">
                <i class="fa-solid fa-plus"></i> New Project
            </button>
        </div>

        <div class="stats-grid" id="statsRow">
            <div class="stat-card">
                <div class="w-10 h-10 rounded-full bg-blue-500/10 text-blue-500 flex items-center justify-center text-lg"><i class="fa-solid fa-layer-group"></i></div>
                <div><div class="text-2xl font-bold" id="statTotal">0</div><div class="text-xs font-bold text-[var(--text-muted)] uppercase tracking-wider">Total Projects</div></div>
            </div>
            <div class="stat-card">
                <div class="w-10 h-10 rounded-full bg-amber-500/10 text-amber-500 flex items-center justify-center text-lg"><i class="fa-solid fa-star"></i></div>
                <div><div class="text-2xl font-bold" id="statFav">0</div><div class="text-xs font-bold text-[var(--text-muted)] uppercase tracking-wider">Favorites</div></div>
            </div>
            <div class="stat-card">
                <div class="w-10 h-10 rounded-full bg-purple-500/10 text-purple-500 flex items-center justify-center text-lg"><i class="fa-solid fa-video"></i></div>
                <div><div class="text-2xl font-bold">12</div><div class="text-xs font-bold text-[var(--text-muted)] uppercase tracking-wider">Scenes Scheduled</div></div>
            </div>
        </div>

        <h3 class="text-sm font-bold text-[var(--text-muted)] uppercase tracking-widest mb-6" id="gridTitle">Recent Projects</h3>
        <div id="projectGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
    </div>

    <div id="createModal" class="modal-overlay">
        <div class="modal-panel">
            <button onclick="closeCreateModal()" class="absolute top-6 right-6 text-gray-500 hover:text-white transition"><i class="fa-solid fa-xmark text-xl"></i></button>
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold mb-2">What are you creating?</h2>
                <p class="text-[var(--text-muted)]">Select a workspace to get started.</p>
            </div>
            
            <div class="selection-grid">
                <div class="select-card group" onclick="launchProject('studio')">
                    <div class="mode-badge text-blue-400 border-blue-400">Creative</div>
                    <div class="select-icon bg-blue-500/10 text-blue-500 group-hover:bg-blue-500 group-hover:text-white transition-colors"><i class="fa-solid fa-pen-nib"></i></div>
                    <div>
                        <h3 class="text-lg font-bold mb-1">Studio Mode</h3>
                        <p class="text-xs text-[var(--text-muted)] leading-relaxed">Scriptwriting, Shot Lists, and Visual Storyboarding.</p>
                    </div>
                </div>

                <div class="select-card group" onclick="launchProject('production')">
                    <div class="mode-badge text-amber-400 border-amber-400">Logistics</div>
                    <div class="select-icon bg-amber-500/10 text-amber-500 group-hover:bg-amber-500 group-hover:text-white transition-colors"><i class="fa-solid fa-briefcase"></i></div>
                    <div>
                        <h3 class="text-lg font-bold mb-1">Production Office</h3>
                        <p class="text-xs text-[var(--text-muted)] leading-relaxed">Budgeting, Crew Management, and Gear Lists.</p>
                    </div>
                </div>

                <div class="select-card group" onclick="launchProject('calendar')">
                    <div class="mode-badge text-purple-400 border-purple-400">Marketing</div>
                    <div class="select-icon bg-purple-500/10 text-purple-500 group-hover:bg-purple-500 group-hover:text-white transition-colors"><i class="fa-solid fa-calendar-days"></i></div>
                    <div>
                        <h3 class="text-lg font-bold mb-1">Content Calendar</h3>
                        <p class="text-xs text-[var(--text-muted)] leading-relaxed">Release schedules, social media planning, and events.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allProjects = [];
        let currentFilter = 'all';

        // --- GREETING LOGIC ---
        function updateGreeting() {
            const hour = new Date().getHours();
            const msg = hour < 12 ? "Good Morning" : (hour < 18 ? "Good Afternoon" : "Good Evening");
            document.getElementById('greeting').innerText = `${msg}, Creator`;
            const options = { weekday: 'long', month: 'short', day: 'numeric' };
            document.getElementById('dateDisplay').innerText = new Date().toLocaleDateString('en-US', options) + " • Ready to shoot?";
        }
        updateGreeting();

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const isLight = document.body.classList.contains('light-mode');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
            const icons = document.querySelectorAll('#desktopThemeBtn i, #mobileThemeBtn i');
            icons.forEach(icon => { icon.className = isLight ? 'fa-solid fa-sun w-5 text-center' : 'fa-solid fa-moon w-5 text-center'; });
        }
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') { document.body.classList.add('light-mode'); }

        // --- MODAL LOGIC ---
        function openCreateModal() {
            const modal = document.getElementById('createModal');
            modal.style.display = 'flex';
            requestAnimationFrame(() => modal.classList.add('modal-active'));
        }

        function closeCreateModal() {
            const modal = document.getElementById('createModal');
            modal.classList.remove('modal-active');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        function launchProject(type) {
            const uniqueId = Date.now().toString(36) + Math.random().toString(36).substr(2);
            let target = `/studio.html?id=${uniqueId}`;
            if(type === 'production') target = `/production.html?id=${uniqueId}`;
            if(type === 'calendar') target = `/calendar.html?id=${uniqueId}`;
            window.location.href = target;
        }

        document.addEventListener('DOMContentLoaded', loadProjects);

        async function loadProjects() {
            try {
                const res = await fetch('/api/projects');
                allProjects = await res.json();
                document.getElementById('statTotal').innerText = allProjects.filter(p => !p.isArchived).length;
                document.getElementById('statFav').innerText = allProjects.filter(p => p.isFavorite).length;
                renderProjects();
            } catch(e) { console.error("Error loading", e); }
        }

        function setFilter(type) {
            currentFilter = type;
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            let btnId = type === 'all' ? 'filterAll' : (type === 'fav' ? 'filterFav' : (type === 'arc' ? 'filterArc' : (type === 'prod' ? 'filterProd' : 'filterCal')));
            const btn = document.getElementById(btnId);
            if(btn) btn.classList.add('active');
            
            document.getElementById('gridTitle').innerText = type === 'fav' ? "Favorites" : (type === 'arc' ? "Archived Projects" : "Recent Projects");
            renderProjects();
        }

        function renderProjects() {
            const grid = document.getElementById('projectGrid');
            grid.innerHTML = '';
            
            if (currentFilter === 'all') {
                const createCard = document.createElement('div');
                createCard.className = "project-card create-card";
                createCard.onclick = openCreateModal; // Opens Modal now!
                createCard.innerHTML = `
                    <div class="w-14 h-14 rounded-full bg-blue-600 text-white flex items-center justify-center text-xl shadow-lg shadow-blue-600/30 group-hover:scale-110 transition"><i class="fa-solid fa-plus"></i></div>
                    <span class="font-bold text-sm opacity-60 group-hover:opacity-100 transition">Create New</span>
                `;
                grid.appendChild(createCard);
            }

            const filtered = allProjects.filter(p => {
                if (currentFilter === 'fav') return p.isFavorite && !p.isArchived;
                if (currentFilter === 'arc') return p.isArchived;
                return !p.isArchived;
            });

            filtered.reverse().forEach((p, index) => {
                const date = new Date(p.savedAt || Date.now()).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const card = document.createElement('div');
                card.className = "project-card group";
                
                const gradients = [
                    "from-blue-600 to-violet-600",
                    "from-emerald-500 to-teal-500",
                    "from-orange-500 to-red-500",
                    "from-pink-500 to-rose-500"
                ];
                const grad = gradients[p.id.charCodeAt(p.id.length-1) % gradients.length];

                let targetLink = `/studio.html?id=${p.id}`;
                if (currentFilter === 'prod') targetLink = `/production.html?id=${p.id}`;
                if (currentFilter === 'cal') targetLink = `/calendar.html?id=${p.id}`;
                
                card.onclick = (e) => { if(!e.target.closest('.action-btn')) window.location.href = targetLink; };
                
                const favClass = p.isFavorite ? 'active' : '';
                const favIcon = p.isFavorite ? 'fa-solid' : 'fa-regular';

                card.innerHTML = `
                    <div class="card-cover">
                        <div class="card-gradient bg-gradient-to-br ${grad}"></div>
                        <div class="card-actions">
                            <button class="action-btn favorite ${favClass}" onclick="toggleStatus('${p.id}', 'fav')"><i class="${favIcon} fa-star text-xs"></i></button>
                            <button class="action-btn" onclick="toggleStatus('${p.id}', 'arc')"><i class="fa-solid fa-box-archive text-xs"></i></button>
                            <button class="action-btn delete hover:bg-red-500 hover:text-white hover:border-red-500" onclick="deleteProject('${p.id}')"><i class="fa-solid fa-trash text-xs"></i></button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div>
                            <h3 class="font-bold text-lg leading-tight mb-1 truncate">${p.title || 'Untitled Project'}</h3>
                            <p class="text-xs text-[var(--text-muted)] font-medium"><i class="fa-regular fa-clock mr-1"></i> Edited ${date}</p>
                        </div>
                        <div class="flex items-center justify-between mt-4">
                            <span class="tag tag-script">SCRIPT</span>
                            <div class="flex -space-x-2">
                                <div class="w-6 h-6 rounded-full bg-gray-700 border-2 border-[var(--card-bg)] flex items-center justify-center text-[8px] text-white font-bold">You</div>
                            </div>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
                gsap.from(card, { y: 20, opacity: 0, duration: 0.4, delay: index * 0.05, ease: "power2.out" });
            });
        }

        async function toggleStatus(id, type) {
            const project = allProjects.find(p => p.id == id);
            if (!project) return;
            const updates = { id: id };
            if (type === 'fav') { project.isFavorite = !project.isFavorite; updates.isFavorite = project.isFavorite; }
            if (type === 'arc') { project.isArchived = !project.isArchived; updates.isArchived = project.isArchived; }
            renderProjects();
            await fetch('/api/save-project', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(updates) });
        }

        async function deleteProject(id) {
            if(confirm('Permanently delete this project?')) {
                await fetch(`/api/project/${id}`, {method:'DELETE'});
                allProjects = allProjects.filter(p => p.id != id);
                renderProjects();
            }
        }
    </script>
</body>
</html>